<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Digital Nest</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#f9f9f9;margin:20px}
h1{text-align:center}
.controls{text-align:center;margin-bottom:20px}
input,button{padding:8px;margin:5px;border-radius:6px}
#catalog{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:15px}
.item{background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.2);position:relative;text-align:center}
.item img{max-width:100%;height:150px;object-fit:cover;border-radius:6px}
.stockOverlay{
position:absolute;inset:0;background:rgba(255,0,0,.85);
color:#fff;font-size:22px;font-weight:bold;
display:flex;justify-content:center;align-items:center;
border-radius:8px;
}
.adminOnly{display:none}
</style>
</head>
<body>

<h1>Digital Nest (Online)</h1>

<div class="controls adminOnly">
<input type="file" id="photo">
<input id="name" placeholder="Item Name">
<input id="price" placeholder="Price">
<input id="qty" type="number" placeholder="Qty">
<button onclick="addItem()">Add</button>
<input type="file" id="jsonFile">
<button onclick="importJSON()">Import JSON</button>
</div>

<div id="catalog"></div>

<script>
const isAdmin = location.search.includes("admin=1");
document.querySelectorAll(".adminOnly")
.forEach(e=>e.style.display=isAdmin?"block":"none");

let items=[];
const catalog=document.getElementById("catalog");

fetch("/api/catalog").then(r=>r.json()).then(d=>{
  items=d; render();
});

function save(){
  if(!isAdmin) return;
  fetch("/api/catalog?admin=1",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(items)
  });
}

function addItem(){
  if(!isAdmin) return;
  const f=photo.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    items.push({
      photo:r.result,
      name:name.value,
      price:price.value,
      qty:+qty.value
    });
    save(); render();
  };
  r.readAsDataURL(f);
}

function importJSON(){
  if(!isAdmin) return;
  const f=jsonFile.files[0];
  const r=new FileReader();
  r.onload=()=>{
    items=JSON.parse(r.result);
    fetch("/api/import?admin=1",{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(items)
    }).then(render);
  };
  r.readAsText(f);
}

function render(){
  catalog.innerHTML="";
  items.forEach(it=>{
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML=`
      <img src="${it.photo}">
      <h3>${it.name}</h3>
      <p>Price: ${it.price}</p>
      <p>Qty: ${it.qty}</p>
    `;
    if(isAdmin){
      const b=document.createElement("button");
      b.textContent="Stock Out";
      b.onclick=()=>{it.qty=0;save();render();}
      d.appendChild(b);
    }
    if(it.qty<=0){
      const o=document.createElement("div");
      o.className="stockOverlay";
      o.textContent="STOCK OUT";
      d.appendChild(o);
    }
    catalog.appendChild(d);
  });
}
</script>
</body>
</html>
